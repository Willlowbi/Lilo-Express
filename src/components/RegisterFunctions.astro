<section class="flex flex-col md:flex-row md:h-screen items-center">
    <div
        class="bg-indigo-600 hidden lg:block w-full md:w-1/2 xl:w-2/3 md:h-screen"
    >
        <img
            src="https://source.unsplash.com/random"
            alt=""
            class="w-full h-full object-cover"
        />
    </div>

    <div
        class="bg-white w-full md:max-w-md lg:max-w-full md:w-1/2 xl:w-1/3 md:h-screen px-2 lg:px-4 xl:px-6 flex items-center justify-center md:pt-12 form-container"
    >
        <div class="w-full">
            <h1 class="text-lg md:text-xl font-bold leading-tight mt-12">
                Crea tu cuenta
            </h1>
            <form class="mt-4" id="registrationForm" method="POST">
                <div class="mb-3">
                    <label class="block text-gray-700 text-sm" for="genero"
                        >Género</label
                    >
                    <select
                        name="genero"
                        id="genero"
                        class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                    >
                        <option value="hombre">Hombre</option>
                        <option value="mujer">Mujer</option>
                    </select>
                </div>

                <div class="flex flex-wrap -mx-2 mb-2">
                    <div class="w-full md:w-1/2 px-2 mb-2 md:mb-0">
                        <label class="block text-gray-700 text-sm" for="nombre"
                            >Nombre</label
                        >
                        <input
                            type="text"
                            name="nombre"
                            id="nombre"
                            placeholder="Ingresa tu nombre"
                            class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                            required
                        />
                    </div>
                    <div class="w-full md:w-1/2 px-2">
                        <label
                            class="block text-gray-700 text-sm"
                            for="apellido">Apellido</label
                        >
                        <input
                            type="text"
                            name="apellido"
                            id="apellido"
                            placeholder="Ingresa tu apellido"
                            class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                            required
                        />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="block text-gray-700 text-sm" for="email"
                        >Correo Electrónico</label
                    >
                    <input
                        type="email"
                        name="email"
                        id="email"
                        autocomplete="email"
                        placeholder="Ingresa tu correo electrónico"
                        class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                        required
                    />
                </div>

                <div class="flex flex-wrap -mx-2 mb-2">
                    <!-- Contraseña -->
                    <div class="w-full px-2">
                        <label
                            class="block text-gray-700 text-sm"
                            for="password">Contraseña</label
                        >
                        <div x-data="{ showPassword: false }" class="relative">
                            <input
                                :type="showPassword ? 'text' : 'password'"
                                name="password"
                                id="password"
                                placeholder="Ingresa tu contraseña"
                                minlength="6"
                                class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none pr-10"
                                required
                            />
                            <div
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 mt-2"
                            >
                                <i
                                    @click="showPassword = !showPassword"
                                    :class="showPassword ? 'fas fa-eye-slash fa-lg' : 'fas fa-eye fa-lg'"
                                    class="text-gray-700 cursor-pointer"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Confirmar Contraseña -->
                    <div class="w-full px-2 mt-2">
                        <label
                            class="block text-gray-700 text-sm"
                            for="confirmPassword">Confirmar Contraseña</label
                        >
                        <div
                            x-data="{ showConfirmPassword: false }"
                            class="relative"
                        >
                            <input
                                :type="showConfirmPassword ? 'text' : 'password'"
                                name="confirmPassword"
                                id="confirmPassword"
                                placeholder="Confirma tu contraseña"
                                minlength="6"
                                class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none pr-10"
                                required
                            />
                            <div
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 mt-2"
                            >
                                <i
                                    @click="showConfirmPassword = !showConfirmPassword"
                                    :class="showConfirmPassword ? 'fas fa-eye-slash fa-lg' : 'fas fa-eye fa-lg'"
                                    class="text-gray-700 cursor-pointer"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap -mx-2 mb-2">
                    <div class="w-full md:w-1/2 px-2 mb-2 md:mb-0">
                        <label
                            class="block text-gray-700 text-sm"
                            for="tipoDocumento">Tipo de Documento</label
                        >
                        <select
                            name="tipoDocumento"
                            id="tipoDocumento"
                            class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                            onchange="updateDoc
                                     ()"
                                                    >
                            <option value="cc">Cédula de Ciudadanía</option>
                            <option value="ti">Tarjeta de Identidad</option>
                            <option value="ce">Cédula de Extranjería</option>
                            <option value="p">Pasaporte</option>
                        </select>
                    </div>
                    <div class="w-full md:w-1/2 px-2">
                        <label
                            class="block text-gray-700 text-sm"
                            for="numeroIdentificacion"
                            >N° de Identificación</label
                        >
                        <input
                            type="text"
                            name="numeroIdentificacion"
                            id="numeroIdentificacion"
                            placeholder="Ingresa tu número de identificación"
                            class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                            required
                        />
                    </div>
                </div>

                <div class="flex flex-wrap -mx-2 mb-2">
                    <div class="w-full text-center">
                        <h1 class="text-gray-700 text-xl md:text-lg">
                            Fecha de Nacimiento
                        </h1>
                    </div>
                    <div class="w-full md:w-1/3 px-2 mb-2 md:mb-0">
                        <select
                            id="day-select"
                            name="day-select"
                            class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                        ></select>
                    </div>
                    <div class="w-full md:w-1/3 px-2 mb-2 md:mb-0">
                        <select
                            id="month-select"
                            name="month-select"
                            class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                        ></select>
                    </div>
                    <div class="w-full md:w-1/3 px-2">
                        <select
                            id="year-select"
                            name="year-select"
                            class="w-full px-2 py-1 rounded-lg bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                        ></select>
                    </div>
                </div>

                <button
                    type="submit"
                    class="w-full block bg-indigo-500 hover:bg-indigo-400 focus:bg-indigo-400 text-white font-semibold rounded-lg px-2 py-1 mt-3"
                    >Registrarse</button
                >
            </form>
        </div>
    </div>
</section>
<style>
    @media (max-width: 760px) {
        section {
            padding-top: 30px;
        }
    }
</style>
<script>
    // Este es un ejemplo de una función que puedes llamar cuando tu aplicación se carga o cuando el usuario navega a una nueva ruta.
    async function checkAuthentication() {
    try {
        // Realiza una solicitud al endpoint que verifica la autenticación.
        const response = await fetch('http://localhost:3001/isAuthenticated', {
            method: 'GET',
            credentials: 'include', // Para asegurarte de que las cookies se incluyan con la solicitud.
        });

        const data = await response.json();

        if (data.isAuthenticated) {
            // Si el usuario está autenticado, redirígelo a la página de inicio.
            window.location.href = '/'; // Redirige al usuario a la página principal.
        } else {
            // Si el usuario no está autenticado, aquí puedes manejar otros casos, como permitirle permanecer en la página de login.
            // O podrías redirigirlo a otra página, o simplemente no hacer nada, dependiendo de la lógica de tu aplicación.
        }
    } catch (error) {
        console.error('Hubo un error al verificar la autenticación:', error);
        // Maneja el error según sea apropiado para tu aplicación. 
        // Por ejemplo, podrías mostrar un mensaje de error al usuario o redirigirlo a una página de error general.
    }
    }

    // Llama a esta función cuando tu aplicación se carga o cuando sea apropiado en el ciclo de vida de tu aplicación o componente.
    checkAuthentication();
    async function handleRegistration(event) {
        event.preventDefault();

        const formData = new FormData(event.target);

        const day = formData.get("day-select") as string;
        const month = formData.get("month-select") as string;
        const year = formData.get("year-select") as string;
        const password = formData.get("password") as string;
        const confirmPassword = formData.get("confirmPassword") as string;
        const tipoDocumento = formData.get("tipoDocumento") as string;
        const numeroIdentificacion = formData.get("numeroIdentificacion") as string;

        // Validar el número de identificación para ciertos tipos de documentos
        if (
            (tipoDocumento === "cc" || tipoDocumento === "ti") &&
            (numeroIdentificacion.length !== 10 || isNaN(Number(numeroIdentificacion)))
        ) {
            alert("Número de identificación inválido");
            return;
        }
        
        // Verificación: Las contraseñas deben ser iguales
        if (password !== confirmPassword) {
            alert(
                "Las contraseñas no coinciden. Por favor, verifica y vuelve a intentarlo.",
            );
            return;
        }

        console.log("Día seleccionado:", day);
        console.log("Mes seleccionado:", month);
        console.log("Año seleccionado:", year);

        // Verificar si alguna de las partes de la fecha es null
        if (!day || !month || !year) {
            alert(
                "La fecha de nacimiento es inválida. Por favor, selecciona una fecha válida.",
            );
            return;
        }

        const newUser = {
            genero: formData.get("genero"),
            nombre: formData.get("nombre"),
            apellido: formData.get("apellido"),
            email: formData.get("email"),
            password: formData.get("password"),
            tipoDocumento: formData.get("tipoDocumento"),
            numeroIdentificacion: formData.get("numeroIdentificacion"),
            fechaNacimiento: `${year}-${String(month).padStart(
                2,
                "0",
            )}-${String(day).padStart(2, "0")}`,
        };

        console.log("Fecha formateada:", newUser.fechaNacimiento);

        // Validación básica de la fecha
        const datePattern = /^\d{4}-\d{2}-\d{2}$/;
        if (!datePattern.test(newUser.fechaNacimiento)) {
            alert(
                "La fecha de nacimiento es inválida. Por favor, selecciona una fecha válida.",
            );
            return;
        }

        console.log("Iniciando registro...");
        try {
            const response = await fetch("http://localhost:3001/register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(newUser),
            });

            // Aquí es donde manejamos las respuestas específicas del servidor
            if (response.status === 400) {
                const errorMessage = await response.text();
                if (errorMessage.includes('email')) {
                    alert('Usuario ya registrado con ese email.');
                } else if (errorMessage.includes('número de identificación')) {
                    alert('Usuario ya registrado con ese número de identificación.');
                } else {
                    alert(errorMessage);  // En caso de que haya otro mensaje de error
                }
                return;
            }

            if (response.ok) {
                window.location.href = "/Login";
            } else {
                alert("Error durante el registro. Por favor, inténtalo de nuevo.");
            }
        } catch (error) {
            console.error("Error en fetch:", error);
        }

    }
    function updateDocumentType() {
        const tipoDocumentoSelect = document.getElementById(
            "tipoDocumento",
        ) as HTMLSelectElement;
        const numeroIdentificacionInput = document.getElementById(
            "numeroIdentificacion",
        ) as HTMLInputElement;

        if (
            tipoDocumentoSelect.value === "cc" ||
            tipoDocumentoSelect.value === "ti"
        ) {
            numeroIdentificacionInput.addEventListener(
                "input",
                restrictToNumbers,
            );
            numeroIdentificacionInput.setAttribute("maxlength", "10"); // Máximo 10 caracteres
            numeroIdentificacionInput.setAttribute("inputmode", "numeric"); // Teclado numérico en dispositivos móviles
        } else {
            numeroIdentificacionInput.removeEventListener(
                "input",
                restrictToNumbers,
            );
            numeroIdentificacionInput.removeAttribute("maxlength");
            numeroIdentificacionInput.removeAttribute("inputmode");
        }
    }

    function restrictToNumbers(event) {
        // Si el valor no es un número, lo reemplaza con una cadena vacía
        event.target.value = event.target.value.replace(/[^\d]/g, "");
    }

    // Función para calcular la edad basada en la fecha de nacimiento
function calculateAge(birthday) {
    var today = new Date();
    var birthDate = new Date(birthday);
    var age = today.getFullYear() - birthDate.getFullYear();
    var m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}

// Función que se llamará cuando cambie la fecha de nacimiento
function handleBirthdateChange() {
    // Obteniendo los valores seleccionados
    const day = (document.getElementById("day-select") as HTMLSelectElement).value;
    const month = (document.getElementById("month-select") as HTMLSelectElement).value;
    const year = (document.getElementById("year-select") as HTMLSelectElement).value;

    // Calcular la edad
    const age = calculateAge(`${year}-${month}-${day}`);

    const tipoDocumentoSelect = document.getElementById("tipoDocumento") as HTMLSelectElement;
    const numeroIdentificacionInput = document.getElementById("numeroIdentificacion") as HTMLInputElement;

    // Lógica para manejar la disponibilidad del tipo de documento en base a la edad
    // Primero, limpia todas las opciones anteriores
    tipoDocumentoSelect.innerHTML = '';

    if (age < 7) {
        // Menores de 7 años: ninguna opción disponible y campo deshabilitado
        tipoDocumentoSelect.disabled = true;
        numeroIdentificacionInput.disabled = true;
        numeroIdentificacionInput.placeholder = "No permitido para menores de 7 años";
    } else if (age >= 7 && age < 18) {
        // Edad entre 7 y 17: permitir solo 'TI' y 'CE'
        tipoDocumentoSelect.disabled = false;
        addSelectOptions(tipoDocumentoSelect, [
            { value: "ti", text: "Tarjeta de Identidad" },
            { value: "ce", text: "Cédula de Extranjería" }
        ]);
        numeroIdentificacionInput.disabled = false;
        numeroIdentificacionInput.placeholder = "Ingresa tu número de identificación";
    } else {
        // Mayores de 18: todas las opciones, excepto 'TI'
        tipoDocumentoSelect.disabled = false;
        addSelectOptions(tipoDocumentoSelect, [
            { value: "cc", text: "Cédula de Ciudadanía" },
            { value: "ce", text: "Cédula de Extranjería" },
            { value: "ps", text: "Pasaporte" }
        ]);
        numeroIdentificacionInput.disabled = false;
        numeroIdentificacionInput.placeholder = "Ingresa tu número de identificación";
    }
}

// Función auxiliar para agregar opciones al select
function addSelectOptions(selectElement, optionsData) {
    for (const optionData of optionsData) {
        const option = document.createElement("option");
        option.value = optionData.value;
        option.textContent = optionData.text;
        selectElement.appendChild(option);
    }
}

    document.addEventListener("DOMContentLoaded", function () {
        const tipoDocumentoSelect = document.getElementById(
            "tipoDocumento",
        ) as HTMLSelectElement;
        tipoDocumentoSelect.addEventListener("change", updateDocumentType);

        updateDocumentType(); // Llamada inicial para configurar según el valor predeterminado

        // Función para añadir días
        const daysSelect = document.querySelector("#day-select");
        for (let i = 1; i <= 31; i++) {
            const option = document.createElement("option");
            option.value = i.toString(); // Convertir a cadena (string)
            option.textContent = i.toString();
            daysSelect.appendChild(option);
        }

        // Función para añadir meses
        const monthsSelect = document.querySelector("#month-select");
        const months = [
            "Enero",
            "Febrero",
            "Marzo",
            "Abril",
            "Mayo",
            "Junio",
            "Julio",
            "Agosto",
            "Septiembre",
            "Octubre",
            "Noviembre",
            "Diciembre",
        ];
        months.forEach((month, index) => {
            const option = document.createElement("option");
            option.value = (index + 1).toString(); // Convertir a cadena (string)
            option.textContent = month;
            monthsSelect.appendChild(option);
        });

        // Función para añadir años
        const yearsSelect = document.querySelector("#year-select");
        const currentYear = new Date().getFullYear();
        for (let i = currentYear; i >= 1900; i--) {
            const option = document.createElement("option");
            option.value = i.toString(); // Convertir a cadena (string)
            option.textContent = i.toString();
            yearsSelect.appendChild(option);
        }
        // Adjuntar el manejador de eventos
        document
            .querySelector("#registrationForm")
            .addEventListener("submit", handleRegistration);

        // Agregar el evento de cambio a los elementos de selección de la fecha de nacimiento
        document.getElementById("day-select").addEventListener("change", handleBirthdateChange);
        document.getElementById("month-select").addEventListener("change", handleBirthdateChange);
        document.getElementById("year-select").addEventListener("change", handleBirthdateChange);

        // Llamada inicial en caso de que la fecha ya esté seleccionada (opcional)
        handleBirthdateChange();
    });

    function formatInputName(input) {
    // Permitir solo letras, espacios y letras acentuadas
    input.value = input.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+/g, "");

    // Capitalizar la primera letra de cada palabra
    input.value = input.value
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    // Ejemplo de uso:
    document.getElementById("nombre").addEventListener("input", function() {
        formatInputName(this);
    });

    document.getElementById("apellido").addEventListener("input", function() {
        formatInputName(this);
    });
</script>
